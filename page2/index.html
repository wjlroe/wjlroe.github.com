
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Will Roe&#146;s blog</title>
  <meta name="author" content="Will Roe">

  
  <meta name="description" content="There are two main ways to build strings in Clojure: str and
format. str essentially does string concatenation like
this: 1
(str &quot;This is a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.wjlr.org.uk/page2/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Will Roe&#146;s blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Caudex:400,700,400italic,700italic&subset=latin,greek-ext,greek,latin-ext'
      rel='stylesheet' type='text/css'>
<script type="text/javascript" src="//use.typekit.net/ntz0pdz.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

<!-- For iPhone 6 Plus with @3× display: -->
<link rel="apple-touch-icon-precomposed" sizes="180x180" href="/images/apple-touch-icon-180x180-precomposed.png">
<!-- For iPad with @2× display running iOS ≥ 7: -->
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/apple-touch-icon-152x152-precomposed.png">
<!-- For iPad with @2× display running iOS ≤ 6: -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">
<!-- For iPhone with @2× display running iOS ≥ 7: -->
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120-precomposed.png">
<!-- For iPhone with @2× display running iOS ≤ 6: -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≥ 7: -->
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/apple-touch-icon-76x76-precomposed.png">
<!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≤ 6: -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-57x57-precomposed.png"><!-- 57×57px -->

  
  <script type="text/javascript">
    if(!window.location.href.match(/localhost/) &&
       !window.location.href.match(/\d+\.\d+\.\d+\.\d+/)) {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7810285-4']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    }
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Will Roe&#146;s blog</a></h1>
  
  <h2 class="subtitle">
    A variety of geekery
    &raquo;
    <a href="/blog/archives" title="Archives">Archives</a>
  </h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/01/15/string-interpolation-clojure.html">Fast String Interpolation in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-15T21:55:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There are two main ways to build strings in Clojure: <a href="https://clojuredocs.org/clojure.core/str"><code>str</code></a> and
<a href="https://clojuredocs.org/clojure.core/format"><code>format</code></a>. <code>str</code> essentially does string concatenation like
this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">str </span><span class="s">&quot;This is a sentence with &quot;</span> <span class="nb">some </span><span class="s">&quot; variables &quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I find <code>str</code> forms somewhat unreadable, especially on one line. They
require the reader to mentally keep track of quote marks and spaces
around variables.</p>

<p>On the other hand, <code>format</code> offers a fully-featured string interpolation
function using Java&#8217;s <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Formatter.html">Formatter</a> class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">format</span> <span class="s">&quot;This string has another string: %s in it and a number: %.2f&quot;</span>
</span><span class='line'>         <span class="s">&quot;hello!&quot;</span>
</span><span class='line'>         <span class="mf">30.1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In ruby we might use string interpolation thus:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">str_interpolate</span> <span class="nb">name</span><span class="p">,</span> <span class="n">profession</span><span class="p">,</span> <span class="n">born</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;The person named </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> works as a </span><span class="si">#{</span><span class="n">profession</span><span class="si">}</span><span class="s2"> and was born in </span><span class="si">#{</span><span class="n">born</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">str_interpolate</span> <span class="s2">&quot;Ethel Smyth&quot;</span><span class="p">,</span> <span class="s2">&quot;Composer&quot;</span><span class="p">,</span> <span class="mi">1858</span>
</span></code></pre></td></tr></table></div></figure>


<p>The advantage of string interpolation like this is how readable the
code can be.</p>

<p>The problem with prefering <code>format</code> over <code>str</code> is the difference in
performance. <code>format</code> is a lot more complex and if all you&#8217;re doing is
string concatenation, then it&#8217;ll not do the job as quickly as <code>str</code>
does (which uses a <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/StringBuilder.html">StringBuilder</a> under the hood).</p>

<h2>Benchmarks!</h2>

<p>The following code uses the <a href="https://github.com/hugoduncan/criterium">Criterium</a> library aliased to <code>bench</code>.</p>

<p>First let&#8217;s define a function using <code>str</code> and benchmark it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">str-concat-fun</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">name </span><span class="nv">profession</span> <span class="nv">born</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">str </span><span class="s">&quot;The person named &quot;</span>
</span><span class='line'>       <span class="nv">name</span>
</span><span class='line'>       <span class="s">&quot; works as a &quot;</span>
</span><span class='line'>       <span class="nv">profession</span>
</span><span class='line'>       <span class="s">&quot; and was born in &quot;</span>
</span><span class='line'>       <span class="nv">born</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">bench/bench</span> <span class="p">(</span><span class="nf">str-concat-fun</span> <span class="nb">name </span><span class="nv">profession</span> <span class="nv">born</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which results in (256ns):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">Evaluation</span> <span class="nb">count </span><span class="err">:</span> <span class="mi">241104540</span> <span class="nv">in</span> <span class="mi">60</span> <span class="nv">samples</span> <span class="nv">of</span> <span class="mi">4018409</span> <span class="nv">calls.</span>
</span><span class='line'>             <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">mean</span> <span class="err">:</span> <span class="mf">256.236563</span> <span class="nv">ns</span>
</span><span class='line'>    <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">std-deviation</span> <span class="err">:</span> <span class="mf">4.617404</span> <span class="nv">ns</span>
</span><span class='line'>   <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">lower</span> <span class="nv">quantile</span> <span class="err">:</span> <span class="mf">250.226629</span> <span class="kd">ns </span><span class="p">(</span> <span class="mf">2.5</span><span class="nv">%</span><span class="p">)</span>
</span><span class='line'>   <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">upper</span> <span class="nv">quantile</span> <span class="err">:</span> <span class="mf">266.339191</span> <span class="kd">ns </span><span class="p">(</span><span class="mf">97.5</span><span class="nv">%</span><span class="p">)</span>
</span><span class='line'>                   <span class="nv">Overhead</span> <span class="nv">used</span> <span class="err">:</span> <span class="mf">1.166050</span> <span class="nv">ns</span>
</span><span class='line'>
</span><span class='line'><span class="nv">Found</span> <span class="mi">5</span> <span class="nv">outliers</span> <span class="nv">in</span> <span class="mi">60</span> <span class="nv">samples</span> <span class="p">(</span><span class="mf">8.3333</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">low-severe</span>       <span class="mi">5</span> <span class="p">(</span><span class="mf">8.3333</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'> <span class="nv">Variance</span> <span class="nv">from</span> <span class="nv">outliers</span> <span class="err">:</span> <span class="mf">7.7764</span> <span class="nv">%</span> <span class="nv">Variance</span> <span class="nv">is</span> <span class="nv">slightly</span> <span class="nv">inflated</span> <span class="nv">by</span> <span class="nv">outliers</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&#8217;s check the <code>format</code> version:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">format-fun</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">name </span><span class="nv">profession</span> <span class="nv">born</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;The person named %s works as a %s and was born in %d&quot;</span>
</span><span class='line'>          <span class="nv">name</span>
</span><span class='line'>          <span class="nv">profession</span>
</span><span class='line'>          <span class="nv">born</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">bench/bench</span> <span class="p">(</span><span class="nf">format-fun</span> <span class="nb">name </span><span class="nv">profession</span> <span class="nv">born</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which results in (1.7µs):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">Evaluation</span> <span class="nb">count </span><span class="err">:</span> <span class="mi">34997760</span> <span class="nv">in</span> <span class="mi">60</span> <span class="nv">samples</span> <span class="nv">of</span> <span class="mi">583296</span> <span class="nv">calls.</span>
</span><span class='line'>             <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">mean</span> <span class="err">:</span> <span class="mf">1.703759</span> <span class="err">µ</span><span class="nv">s</span>
</span><span class='line'>    <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">std-deviation</span> <span class="err">:</span> <span class="mf">36.732362</span> <span class="nv">ns</span>
</span><span class='line'>   <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">lower</span> <span class="nv">quantile</span> <span class="err">:</span> <span class="mf">1.663752</span> <span class="err">µ</span><span class="nv">s</span> <span class="p">(</span> <span class="mf">2.5</span><span class="nv">%</span><span class="p">)</span>
</span><span class='line'>   <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">upper</span> <span class="nv">quantile</span> <span class="err">:</span> <span class="mf">1.779579</span> <span class="err">µ</span><span class="nv">s</span> <span class="p">(</span><span class="mf">97.5</span><span class="nv">%</span><span class="p">)</span>
</span><span class='line'>                   <span class="nv">Overhead</span> <span class="nv">used</span> <span class="err">:</span> <span class="mf">1.166050</span> <span class="nv">ns</span>
</span><span class='line'>
</span><span class='line'><span class="nv">Found</span> <span class="mi">2</span> <span class="nv">outliers</span> <span class="nv">in</span> <span class="mi">60</span> <span class="nv">samples</span> <span class="p">(</span><span class="mf">3.3333</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">low-severe</span>       <span class="mi">2</span> <span class="p">(</span><span class="mf">3.3333</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'> <span class="nv">Variance</span> <span class="nv">from</span> <span class="nv">outliers</span> <span class="err">:</span> <span class="mf">9.4397</span> <span class="nv">%</span> <span class="nv">Variance</span> <span class="nv">is</span> <span class="nv">slightly</span> <span class="nv">inflated</span> <span class="nv">by</span> <span class="nv">outliers</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s not good, but not entirely unexpected. An order of magnitude
slower to use <code>format</code> for string contatenation tasks like this.</p>

<p>One of the advantages of Clojure is the promise of powerful,
expressive abstractions and not having to compromise on those
abstractions to achieve performance. In a <a href="http://cemerick.com/2009/12/04/string-interpolation-in-clojure/">blog post</a> about
string interpolation in Clojure, Chas Emerick proposes a macro for
simple string interpolation that would behave much like Ruby&#8217;s does.
This has made its way into the <a href="https://github.com/clojure/core.incubator/">core.incubator</a> project and can be
used in projects today.</p>

<p>To require it, add <code>core.incubator</code> to your project&#8217;s dependencies and
add the following to any namespace that needs it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">example...</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.core.strint</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">&lt;&lt;</span><span class="p">]]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now we can define a function like the others using this new macro:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">interpolation-fun</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">name </span><span class="nv">profession</span> <span class="nv">born</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">&lt;&lt;</span> <span class="s">&quot;The person named ~{name} works as a ~{profession} and was born in ~{born}&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">bench/bench</span> <span class="p">(</span><span class="nf">interpolation-fun</span> <span class="nb">name </span><span class="nv">profession</span> <span class="nv">born</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this results in (272ns):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">Evaluation</span> <span class="nb">count </span><span class="err">:</span> <span class="mi">222317940</span> <span class="nv">in</span> <span class="mi">60</span> <span class="nv">samples</span> <span class="nv">of</span> <span class="mi">3705299</span> <span class="nv">calls.</span>
</span><span class='line'>             <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">mean</span> <span class="err">:</span> <span class="mf">271.580867</span> <span class="nv">ns</span>
</span><span class='line'>    <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">std-deviation</span> <span class="err">:</span> <span class="mf">2.117763</span> <span class="nv">ns</span>
</span><span class='line'>   <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">lower</span> <span class="nv">quantile</span> <span class="err">:</span> <span class="mf">267.593081</span> <span class="kd">ns </span><span class="p">(</span> <span class="mf">2.5</span><span class="nv">%</span><span class="p">)</span>
</span><span class='line'>   <span class="nv">Execution</span> <span class="nb">time </span><span class="nv">upper</span> <span class="nv">quantile</span> <span class="err">:</span> <span class="mf">274.826087</span> <span class="kd">ns </span><span class="p">(</span><span class="mf">97.5</span><span class="nv">%</span><span class="p">)</span>
</span><span class='line'>                   <span class="nv">Overhead</span> <span class="nv">used</span> <span class="err">:</span> <span class="mf">1.166050</span> <span class="nv">ns</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not bad! Ever so slightly slower than the <code>str</code> version but a
performance penalty well worth paying for to get more expressive
string interpolation I feel.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/01/06/2014-in-books.html">2014 in Books</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-06T14:45:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:45 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>According to <a href="https://www.goodreads.com/">GoodReads</a> I read 17 books
this year. Here are some I really liked.</p>

<p><img src="https://d.gr-assets.com/books/1394357588l/19932464.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/19932464-kindred">Kindred by Octavia Butler</a>
</h2>


<p>Kindred is classified as sci-fi, but that doesn’t do it justice
really. It’s more of a sci-fi conceit (time-shifting) to allow Butler
to immerse the reader in the world of 1815 on a plantation with
slaves. The protagonist is black and the abrupt time shift lands her
in palpable danger. The relationships between characters was always
nuanced and interesting and the tension was high throughout - tension
from real danger. I especially appreciated the subtle way Butler
weaved in historical names and events into the narrative. I will
definitely be reading more of Octavia Butler’s books.</p>

<p><img src="https://d.gr-assets.com/books/1383652605l/18754367.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/18754367-nothing-o-clock">Nothing O&#8217;Clock by Neil Gaiman</a>
</h2>


<p>Part of a series of short stories, one for each Doctor, released on
the 50th anniversary of Doctor Who. This was an undemanding
entertaining read and I intend to read more of them.</p>

<p><img src="https://d.gr-assets.com/books/1328327063l/13127093.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/13127093-flat-earth-news">Flat-Earth News by Nick Davies</a>
</h2>


<p>We all know the media are dreadful, but just how dreadful and why?
This book attempts to shine some light on the shady world of British
media (although for the most part the same problems exist elsewhere).
It is somewhat unscrupulous in aiming its critical eye at broadsheet
and tabloid alike and generally castigates broadsheets for pumping out
unchecked nonsense because we expect them to be a cut above the
tabloids (spoiler: they’re not). Shocking, sickening, depressing
- exactly what you’d expect from a book about newspapers.</p>

<p><img src="https://d.gr-assets.com/books/1407785478l/22903174.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/22903174-clipping-through">Clipping Through by Leigh Alexander</a>
</h2>


<p>This book by my favourite games journalist - Leigh Alexander - takes
you into the surreal world of games journalism itself. Part stream of
consciousness and part short biography this is a world most of us have
no idea about. It kept me entertained on a few train commutes.
<a href="https://gumroad.com/l/aisCU">You can and should buy it here</a></p>

<p><img src="https://d.gr-assets.com/books/1401632138l/22387085.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/22387085-a-natural-history-of-dragons-a-memoir-of-lady-trent">A Natural History of Dragons by Marie Brennan</a>
</h2>


<p>The first part of a series of books about the main character - Lady
Trent. A cross between Pride and Prejudice and Reign of Fire, sort of.
Thoroughly entertaining and I shall be reading the rest of the series.</p>

<p><img src="https://d.gr-assets.com/books/1328302275l/10081041.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/10081041-the-long-ships">The Long ships by Frans Bengtsson</a>
</h2>


<p>This Swedish classic about Vikings in the 10th century in Denmark was
a surprisingly good read. The humour was super dry and for some
considerable time it passed me by. My main criticism of it is that
it’s rather overly long and the novelty of the sarcasm wore out well
before the end for me.</p>

<p><img src="https://d.gr-assets.com/books/1351039314l/11272152.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/11272152-jane-eyre">Jane Eyre by Charlotte Brontë</a>
</h2>


<p>Quite simply a must read. I particularly enjoyed cross-referencing
with King Lear and the various other literary works Brontë weaves in.</p>

<p><img src="https://d.gr-assets.com/books/1348918036l/2639853.jpg" class="book-cover"></p>

<h2>
  <a href="https://www.goodreads.com/book/show/2639853-to-boulez-and-beyond">To Boulez and Beyond by Joan Peyser</a>
</h2>


<p>The first half of this book is a biography of composers from Debussy
to Boulez, roughly speaking. Lots of time is spent covering
Schoenberg, Berg and Webern as you might expect. The second half of
the book is a biography of Boulez himself. I found the combination
fascinating since it put the musical trends and works of Boulez in
perspective wonderfully. This book lead me to seek out and appreciate
a number of compositions which makes it my favourite of the books I
read in 2014.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/12/30/multi-machine-vagrant-ansible-gotcha.html">Multi-Machine Vagrant Ansible Gotcha</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-30T16:00:00+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:00 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://docs.vagrantup.com/" title="Vagrant">Vagrant</a> is a fantastic tool for defining how virtual instances are
to be run and provisioned. I&#8217;ve used Vagrant with <a href="https://docs.chef.io/chef_solo.html" title="Chef-solo">Chef-Solo</a> and
<a href="http://docs.ansible.com/index.html">Ansible</a> provisioners and it&#8217;s helped me understand those tools and
iterate quickly. There are some gotchas however and in this post I
will explore a particular flaw in the way Vagrant and Ansible
cooperate.</p>

<h2>Multi-machine setup</h2>

<p>Let&#8217;s begin by defining a Vagrant environment that we will play with
(you will need <a href="https://www.virtualbox.org">VirtualBox</a>, Vagrant and Ansible installed):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir multi-vagrant-ansible
</span><span class='line'><span class="nb">cd </span>multi-vagrant-ansible
</span><span class='line'>vagrant init
</span></code></pre></td></tr></table></div></figure>


<p>This will create a <code>Vagrantfile</code> in the current directory with
commented contents. Let&#8217;s cut it back to the essentials and add in a
URL for the base box (<a href="https://cloud-images.ubuntu.com/vagrant/" title="Ubuntu Cloud Vagrant images">Ubuntu Trusty</a> is the latest LTS
release so that&#8217;s what I&#8217;ll use):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;trusty64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://cloud-images.ubuntu.com/vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;dhcp&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we run Vagrant now, it&#8217;ll clone that base box (downloading it first
if it hasn&#8217;t already done so) and boot it up. This is already quicker
than downloading an ISO, creating a new VirtualBox instance, booting
that up and going through the installation procedure.</p>

<p>Let&#8217;s define some machines and set them up to be provisioned by
Ansible. We&#8217;ll have two web servers and one load balancer, because
that&#8217;s boringly conventional:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;ariadne&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ariadne</span><span class="o">|</span>
</span><span class='line'>    <span class="n">ariadne</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;loadbalancer.yml&quot;</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">sudo</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;minos&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">minos</span><span class="o">|</span>
</span><span class='line'>    <span class="n">minos</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;webserver.yml&quot;</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">sudo</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;pasiphae&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">pasiphae</span><span class="o">|</span>
</span><span class='line'>    <span class="n">pasiphae</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;webserver.yml&quot;</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">sudo</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So in the above, <code>minos</code> and <code>pasiphae</code> are web servers (i.e. they
will be running <a href="http://nginx.org">nginx</a>) and <code>ariadne</code> is the load balancer. The
location of the ansible playbooks are relative to the Vagrantfile so
in the same directory we will create <code>webserver.yml</code> with the
following contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=present</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=started</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which ensures that nginx is not only installed but also running (it&#8217;ll
also mean that if that server is rebooted, it&#8217;ll still run nginx).</p>

<p>Now for the load balancer, <code>loadbalancer.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=haproxy state=present</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=haproxy state=started</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which ensures <a href="http://www.haproxy.org">haproxy</a> is installed and running in the same way.</p>

<p>These two playbooks are not aware of each other, they act
independently and you could use <code>ansible-playbook</code> to provision any
server you liked with them.</p>

<p>If you run <code>vagrant up</code> at this point (assuming you&#8217;ve not done that
with this Vagrantfile before), it&#8217;ll boot up new VirtualBox instances
and provision them with ansible, installing the necessary software
etc. All well and good so far.</p>

<h2>Ansible facts</h2>

<p>Ansible starts off by collecting facts about the nodes it&#8217;ll run on.
It does this so that you can use information about the node in your
playbooks, roles and tasks.</p>

<p>To see the kind of facts that ansible collects about a node, you can
run ansible&#8217;s <code>setup</code> module like this (for the minos instance):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ansible -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory -m setup -u vagrant --private-key<span class="o">=</span>.vagrant/machines/minos/virtualbox/private_key minos
</span></code></pre></td></tr></table></div></figure>


<p>The above command should print out a large JSON structure of all the
facts ansible has collected about that node. Ansible facts are
somewhat extensible so it can include information gathered using the
<a href="https://github.com/opscode/ohai">Ohai</a> or <a href="https://github.com/puppetlabs/facter">Facter</a> tools.</p>

<p>The facts relevant to our example are under the <code>ansible_eth1</code>
key and they include an IPv4 address - which will come in handy in a
moment.</p>

<h2>Facts &amp; templates</h2>

<p>Now let&#8217;s create a <a href="http://docs.ansible.com/template_module.html">template</a> for the haproxy configuration (in
<code>templates/haproxy.cfg.j2</code>):</p>

<figure class='code'><figcaption><span>Haproxy config  (haproxy.cfg.j2)</span> <a href='/downloads/code/haproxy.cfg.j2'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='jinja'><span class='line'><span class="x">backend web-backend</span>
</span><span class='line'><span class="x">  balance roundrobin</span>
</span><span class='line'><span class="x">  mode http</span>
</span><span class='line'><span class="x">  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">host</span> <span class="k">in</span> <span class="nv">groups</span><span class="o">[</span><span class="s1">&#39;webservers&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
</span><span class='line'><span class="x">     server </span><span class="cp">{{</span> <span class="nv">host</span> <span class="cp">}}</span><span class="x"> </span><span class="cp">{{</span> <span class="nv">hostvars</span><span class="o">[</span><span class="nv">host</span><span class="o">]</span><span class="nv">.ansible_eth1.ipv4.address</span> <span class="cp">}}</span><span class="x">:80 check</span>
</span><span class='line'><span class="x">  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ll also need to ensure that template gets used in the loadbalancer
playbook:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=haproxy state=present</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=haproxy state=started</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Configure haproxy</span>
</span><span class='line'>      <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=templates/haproxy.cfg.j2 dest=/etc/haproxy/haproxy.cfg</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we run this now, we&#8217;ll get a cryptic error:</p>

<p><code>fatal: [ariadne] =&gt; {'msg': "AnsibleUndefinedVariable: One or more undefined variables: 'dict object' has no attribute 'webservers'", 'failed': True}</code></p>

<p>One possible reason for this is that we haven&#8217;t defined any groups for
our vagrant instances, let&#8217;s do that now. We&#8217;ll start by defining the
groups at the top of the Vagrantfile, before anything else (but after
the emacs/vi mode comments):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">groups</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;webservers&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;minos&quot;</span><span class="p">,</span> <span class="s2">&quot;pasiphae&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;loadbalancers&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;ariadne&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;all_groups:children&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;webservers&quot;</span><span class="p">,</span> <span class="s2">&quot;loadbalancers&quot;</span><span class="o">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This correlates to the playbooks we&#8217;ve assigned for each node in the
Vagrantfile. Then we need to refer to that variable in each of our
machine definitions, adding a line that says <code>ansible.groups =
groups</code>, so the modified ariadne definition should now be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;ariadne&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ariadne</span><span class="o">|</span>
</span><span class='line'>    <span class="n">ariadne</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;loadbalancer.yml&quot;</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">sudo</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">ansible</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we run <code>vagrant provision</code> now we get a different error! Ah Ha!
Progress:</p>

<p><code>fatal: [ariadne] =&gt; {'msg': "AnsibleUndefinedVariable: One or more undefined variables: 'dict object' has no attribute 'ansible_eth1'", 'failed': True}</code></p>

<h2>Oh no!</h2>

<p>It would be useful at this point to examine what we <em>do</em> have in that
dictionary object. Maybe I mistyped the key? In order to do that, we
can add a debug line above the haproxy configuration line in the
<code>loadbalancer.yml</code> file, like this: <code>- debug: var=hostvars['minos']</code>.</p>

<p>When we run <code>vagrant provision</code> now, we will get the facts about minos
printed in JSON to the console. It&#8217;ll look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;hostvars[&#39;minos&#39;]&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;inventory_hostname_short&quot;</span><span class="p">:</span> <span class="s2">&quot;minos&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;inventory_hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;minos&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;group_names&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="s2">&quot;all_groups&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;webservers&quot;</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;ansible_ssh_port&quot;</span><span class="p">:</span> <span class="mi">2200</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;ansible_ssh_host&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Clearly all those facts gathered aren&#8217;t here. Why? The reason for this
is that Vagrant runs provisioning separately on each virtual machine -
so each ansible run is not aware of anything from another ansible
run. If you look this up online, you will find apparent answers to
this problem that reconfigure vagrant to connect to all hosts when
doing an ansible run. Let&#8217;s do that now.</p>

<p>For each ansible block in the Vagrantfile, add the line:
<code>ansible.limit = 'all'</code>. Let&#8217;s try <code>vagrant provision</code> again now
that&#8217;s in place.</p>

<p>The error that I get after making this change is that SSH is failing.
If we add <code>ansible.verbose = 'vvvv'</code> to each ansible block in the
Vagrantfile then with a lot of scrolling around we can deduce that
ansible is attempting to connect to each machine in the inventory
using the same private key as it would for the machine it&#8217;s currently
provisioning. In other words, while provisioning <code>ariadne</code>, it uses
the <code>ariadne</code> private SSH key to log on to both the other servers.
This won&#8217;t work of course because those SSH keys are generated by
Vagrant per machine. Not only that but the private key is on the host
machine, not on the guests so it&#8217;s a fools errand.</p>

<p>I&#8217;m not sure what kind of SSH key setup would allow <code>ansible.limit =
'all'</code> to work at all, but it&#8217;s hardly straightforward.</p>

<h2>Potential workaround: Redis</h2>

<p>The only way I&#8217;ve discovered to have ansible and Vagrant work well
together is to use <a href="http://docs.ansible.com/playbooks_variables.html#fact-caching">Fact Caching</a>. This allows ansible to cache all
facts from a node in Redis (or memcached) so that nodes can refer to
each other without requiring an extra ssh connection for every node.</p>

<p>In order to enable fact caching, you will need Redis installed and
running. Then create an <code>ansible.cfg</code> file in the same directory as
your Vagrantfile, with the following contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='cfg'><span class='line'><span class="k">[defaults]</span>
</span><span class='line'><span class="na">fact_caching</span> <span class="o">=</span> <span class="s">redis</span>
</span><span class='line'><span class="na">fact_caching_timeout</span> <span class="o">=</span> <span class="s">86400</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will need to provision <code>minos</code> and <code>pasiphae</code> first so that their
facts are stored in Redis before provisioning <code>ariadne</code> (because it
refers to those other nodes):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vagrant provision minos
</span><span class='line'>vagrant provision pasiphae
</span></code></pre></td></tr></table></div></figure>


<p>Now that those facts have been gathered, we can run <code>vagrant
provision</code> and it should complete without trouble this time.</p>

<p>Now to verify that the haproxy config has been written as we expect,
we can run <code>vagrant ssh ariadne -- cat /etc/haproxy/haproxy.cfg</code> and
get something akin to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>backend web-backend
</span><span class='line'>  balance roundrobin
</span><span class='line'>  mode http
</span><span class='line'>    server minos 172.28.128.4:80 check
</span><span class='line'>    server pasiphae 172.28.128.5:80 check
</span></code></pre></td></tr></table></div></figure>


<p>It worked! So although fact caching is intended for use in large
organisations with thousands of nodes (possibly in disparate data
centres) to speed up deployment, it can be handy working around
weaknesses in the vagrant+ansible combination.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 Will Roe
  <br>
  <span class="credit">Generated using <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
